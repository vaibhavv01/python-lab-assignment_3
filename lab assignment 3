import csv
import os

# 1. The Book Class (Data Model)
class Book:
    """Represents a single book with ISBN, title, author, and status."""
    def __init__(self, isbn, title, author, status="Available"):
        self.isbn = isbn
        self.title = title
        self.author = author
        self.status = status  # "Available" or "Issued"

    def __str__(self):
        return f"ISBN: {self.isbn} | Title: {self.title:<30} | Author: {self.author:<20} | Status: {self.status}"

# 2. The LibraryManager Class (Business Logic)
class LibraryManager:
    """Manages library operations, including file handling and book management."""
    def __init__(self, filename="library_catalog.csv"):
        self.filename = filename
        self.books = []
        self.load_books()

    def load_books(self):
        """Loads book records from the CSV file."""
        if not os.path.exists(self.filename):
            return
        try:
            with open(self.filename, mode='r', newline='', encoding='utf-8') as file:
                reader = csv.DictReader(file)
                for row in reader:
                    book = Book(row['ISBN'], row['Title'], row['Author'], row['Status'])
                    self.books.append(book)
        except IOError as e:
            print(f"Error loading catalog: {e}")

    def save_books(self):
        """Saves current book records to the CSV file."""
        try:
            with open(self.filename, mode='w', newline='', encoding='utf-8') as file:
                fieldnames = ['ISBN', 'Title', 'Author', 'Status']
                writer = csv.DictWriter(file, fieldnames=fieldnames)
                writer.writeheader()
                for book in self.books:
                    writer.writerow({
                        'ISBN': book.isbn,
                        'Title': book.title,
                        'Author': book.author,
                        'Status': book.status
                    })
            print("Catalog saved successfully.")
        except IOError as e:
            print(f"Error saving catalog: {e}")

    def add_book(self, isbn, title, author):
        """Adds a new book record."""
        if any(book.isbn == isbn for book in self.books):
            print(f"Error: Book with ISBN {isbn} already exists.")
            return False
        new_book = Book(isbn, title, author)
        self.books.append(new_book)
        self.save_books()
        print(f"Added: '{title}' by {author}")
        return True

    def search_catalog(self, query):
        """Searches for books by title, author, or ISBN."""
        query = query.lower()
        results = [
            book for book in self.books
            if query in book.title.lower() or
               query in book.author.lower() or
               query == book.isbn.lower()
        ]
        return results

    def _find_book_by_isbn(self, isbn):
        """Helper to find a book object by ISBN."""
        for book in self.books:
            if book.isbn == isbn:
                return book
        return None

    def update_status(self, isbn, new_status):
        """Updates the status of a specific book (Issue/Return)."""
        book = self._find_book_by_isbn(isbn)
        if book:
            if new_status in ["Issued", "Available"]:
                book.status = new_status
                self.save_books()
                print(f"Status of ISBN {isbn} updated to '{new_status}'.")
            else:
                print("Invalid status provided. Use 'Issued' or 'Available'.")
        else:
            print(f"Error: Book with ISBN {isbn} not found.")

    def list_all_books(self):
        """Displays all books currently in the catalog."""
        if not self.books:
            print("The library catalog is currently empty.")
            return
        print("\n--- Current Library Catalog ---")
        for book in self.books:
            print(book)
        print("-------------------------------\n")

# 3. The Main CLI Function (User Interface)
def main():
    manager = LibraryManager()
    print("Welcome to the Lightweight Library Manager CLI.")

    while True:
        print("\nMenu:")
        print("1. Add a new book")
        print("2. Search catalog")
        print("3. List all books")
        print("4. Issue a book (Update status)")
        print("5. Return a book (Update status)")
        print("6. Exit")

        choice = input("Enter your choice (1-6): ")

        if choice == '1':
            isbn = input("Enter ISBN: ")
            title = input("Enter Title: ")
            author = input("Enter Author: ")
            manager.add_book(isbn, title, author)
        elif choice == '2':
            query = input("Enter search query (Title, Author, or ISBN): ")
            results = manager.search_catalog(query)
            if results:
                print("\n--- Search Results ---")
                for book in results:
                    print(book)
                print("----------------------\n")
            else:
                print("No matching books found.")
        elif choice == '3':
            manager.list_all_books()
        elif choice == '4':
            isbn = input("Enter ISBN of book to issue: ")
            manager.update_status(isbn, "Issued")
        elif choice == '5':
            isbn = input("Enter ISBN of book to return: ")
            manager.update_status(isbn, "Available")
        elif choice == '6':
            print("Exiting application.")
            break
        else:
            print("Invalid choice. Please enter a number between 1 and 6.")

if __name__ == "__main__":
    main()
